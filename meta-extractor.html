<script>
        // Lógica de Subida y Arrastre
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const results = document.getElementById('results');
        const previewImg = document.getElementById('preview-img');
        let map = null;

        dropZone.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', function(e) {
            handleFile(e.target.files[0]);
        });

        // Drag & Drop effects
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#fff';
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#333';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = '#333';
            handleFile(e.dataTransfer.files[0]);
        });

        function handleFile(file) {
            if (!file || !file.type.match('image/jpeg')) {
                alert('ERROR: Please upload a valid JPG/JPEG image.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                previewImg.src = e.target.result;
                
                // CORRECCION: Esperar a que la imagen cargue visualmente antes de leer EXIF
                previewImg.onload = function() {
                    results.style.display = 'block';
                    analyzeExif(previewImg);
                }
            };
            reader.readAsDataURL(file);
        }

        function analyzeExif(imgElement) {
            // Resetear datos visuales antes de empezar
            document.getElementById('cam-model').innerText = "---";
            document.getElementById('date-taken').innerText = "---";
            document.getElementById('software').innerText = "---";
            document.getElementById('iso').innerText = "---";
            document.getElementById('exposure').innerText = "---";
            document.getElementById('gps-status').innerText = "ANALYZING...";
            document.getElementById('gps-status').style.color = "var(--neon-green)";
            
            document.getElementById('map').style.display = 'none';
            document.getElementById('no-gps').style.display = 'none';

            // Pequeño timeout para asegurar que el DOM está listo
            setTimeout(() => {
                EXIF.getData(imgElement, function() {
                    console.log("EXIF DATA EXTRACTED:", this.exifdata); // Debug en consola

                    // Extraer datos básicos con comprobaciones de seguridad
                    const make = EXIF.getTag(this, "Make") || "";
                    const model = EXIF.getTag(this, "Model") || "Unknown Device";
                    const date = EXIF.getTag(this, "DateTime") || "Unknown Date";
                    const software = EXIF.getTag(this, "Software") || "Unknown";
                    const iso = EXIF.getTag(this, "ISOSpeedRatings") || "---";
                    
                    let exposure = "---";
                    const expTime = EXIF.getTag(this, "ExposureTime");
                    if(expTime) {
                        exposure = (expTime >= 1) ? expTime : "1/" + Math.round(1/expTime);
                    }

                    // Pintar tabla
                    document.getElementById('cam-model').innerText = `${make} ${model}`;
                    document.getElementById('date-taken').innerText = date;
                    document.getElementById('software').innerText = software;
                    document.getElementById('iso').innerText = iso;
                    document.getElementById('exposure').innerText = exposure;

                    // Extraer GPS
                    const lat = EXIF.getTag(this, "GPSLatitude");
                    const lon = EXIF.getTag(this, "GPSLongitude");
                    const latRef = EXIF.getTag(this, "GPSLatitudeRef");
                    const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

                    if (lat && lon) {
                        const decimalLat = convertDMSToDD(lat, latRef);
                        const decimalLon = convertDMSToDD(lon, lonRef);
                        
                        document.getElementById('gps-status').innerText = `LOCKED: ${decimalLat.toFixed(5)}, ${decimalLon.toFixed(5)}`;
                        
                        showMap(decimalLat, decimalLon);
                    } else {
                        document.getElementById('gps-status').innerText = "NOT FOUND (Clean Image)";
                        document.getElementById('gps-status').style.color = "#ff0041";
                        document.getElementById('no-gps').style.display = 'block';
                    }
                });
            }, 100);
        }

        function convertDMSToDD(dms, ref) {
            let dd = dms[0] + dms[1]/60 + dms[2]/3600;
            if (ref == "S" || ref == "W") {
                dd = dd * -1;
            }
            return dd;
        }

        function showMap(lat, lon) {
            const mapContainer = document.getElementById('map');
            mapContainer.style.display = 'block';

            // Reiniciar mapa si ya existe para evitar errores de renderizado
            if (map !== null) {
                map.off();
                map.remove();
            }

            map = L.map('map').setView([lat, lon], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            L.marker([lat, lon]).addTo(map)
                .bindPopup('TARGET LOCATION FOUND')
                .openPopup();
        }
    </script>
